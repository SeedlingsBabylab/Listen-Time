---
title: "Listened time analysis by month"
author: "Sarp Uner"
date: "10/22/2019"
output: html_document
---

```{r setup, include=FALSE, fig.width=8, fig.asp=0.618}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
library(tidyverse)
library(kableExtra)
```

## Listened Time

The final listened time output generated by the python script.  Below, we read the Total_Listen_Time_Summary.csv file, and pull the month data from the filename for later use.

```{r read, message=FALSE}
listened_time <- read_csv("output/Total_Listen_Time_Summary.csv")
listened_time_with_months <- listened_time %>% 
    mutate(month = str_match(filename, "_(\\d{2})_")[,2]) %>% 
  #eb: there are much easier ways to d o this in r:)
  # cf strings cheatsheet here https://rstudio.com/resources/cheatsheets/
    select(filename, month, everything())
```

Here we calculate the average listen time per month in hours, rounded to two decimal places. 
```{r avg}
avgs <- listened_time_with_months %>% 
  group_by(month) %>% 
  summarise(avg_listen_time = round(mean(total_listen_time_hour), 2))

knitr::kable(
  avgs,
  caption = "Mean listened time per month in hours"
) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

The maximum and minimum time listened per month. This should be a general indication of issues for that month's listened times.
```{r maxmin}
maxmin <- listened_time_with_months %>% #eb: outlier has a technical definition in stats that this doesn't meet
  group_by(month) %>% 
  summarise(max = max(total_listen_time_hour), min = min(total_listen_time_hour))
knitr::kable(
  maxmin,
  caption = "The maximum and minimum listened time per month in hours"
) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

Below is a short section of the format of the csv file with only the **hour variables**. This should help with quick sanity checks. Note that for months 6 and 7, total listen time is calculated by subtracting skip and silence times from the last available time stamp in a file. 
```{r mutated, echo=FALSE}
knitr::kable(
  listened_time_with_months[1:5,] %>% select(filename, ends_with("hour")),
  caption = "A tibble of listened time csv file"
) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = 'left')
```

## Listen Time Histograms 
Below are the histograms for each month. 
```{r histograms, out.width="%25"}
ggplot(data = listened_time_with_months) + geom_histogram(mapping = aes(x = total_listen_time_hour),binwidth=.25) + facet_wrap(~ month, scales = "free")
```

## Problem File List
n.b.: these are only the problematic files IF total_listen_time_hour is being calculated properly, which i'm not sure it is...please look into it.

### month 6 and 7
these dont' have a 'hard and fast' limit on the length, but i'd double check the ones below to make sure
```{r sixseven, message=FALSE}
knitr::kable(
sixseven_summary <- listened_time_with_months %>%
  select(filename, month, silence_time_hour, skip_time_hour, skip_silence_overlap_hour, end_time_hour, total_listen_time_hour) %>%
  filter(month %in% c("06","07") & (total_listen_time_hour>12 | total_listen_time_hour<8)) %>%
  mutate(calculation = sprintf("= %s - (%s + %s - %s)", end_time_hour, skip_time_hour, silence_time_hour, skip_silence_overlap_hour))
) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, fixed_thead = T) %>%
  column_spec(8, width = "2000px")
```

### month 8-13
target length: 4 hours
```{r eight_to_thirteen}
listened_time_with_months %>% 
  filter(month %in% c("08","09","10","11","12","13") & (total_listen_time_hour>4.25 | total_listen_time_hour<3.75))
  
```

### month 14-17
target length: 3 hours
```{r fourteen_to_seventeen}
listened_time_with_months %>% 
  filter(month %in% c("14","15","16","17") & (total_listen_time_hour>3.25 | total_listen_time_hour<2.75))
  
```