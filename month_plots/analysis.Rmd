---
title: "Listened time analysis by month"
author: "Sarp Uner"
date: "`r format(Sys.time())`"
output: html_document
---
<style>
  .bigTable {
    float:left
  }
</style>
```{r setup, include=FALSE, fig.width=8, fig.asp=0.618}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = normalizePath(".."))
#eb: i commented out the above so paths will work as they should; under
# knit you always want the knit directory to be the *project* directory
library(tidyverse)
library(kableExtra)
library(skimr)

```

## Listened Time

The final listened time output generated by the python script.  Below, we read the Total_Listen_Time_Summary.csv file, and pull the month data from the filename for later use.

### Definition of Variables

You can find more detailed information [here, on gitbook](https://bergelsonlab.gitbook.io/blab/data-pipeline/audio/skips-silences-make-up-time-and-extra-time)

Ideally, all of these regions should be marked clearly in all of the cha files as comment lines. 
Here are brief definitions of different regions:

***Subregions***

- Subregions are 1 hour long chunks that have been chosen by scripts for having the highest amount of 'activity'. 
- These are the regions that we have listened to in months 8-17. For months 6 and 7, we listened to the whole file, so there was no need to introduce subregions.
- For all recordings in months 8-17, ideally, 5 subregions were identified. Depending on target length of time to listen to (for months 8-13 target length is 3, whereas for 14-17 it is 3), the subregions were ranked from best to worst (in terms of activity) and listened to accordingly.  

***Skips***

- Skips are sections of recording (at least 10 minutes long) that do not contain any decipherable language. 
- Naps, car rides without decipherable speech, shopping trips without speech are all examples of skips. 
- For months 6 and 7, these are not modified. For months 8-17, we modify their start-end timestamps for calculation listened time. More detailed information about this can be found below in the Month 6 and 7 section. 

***Silences***

- Silences are silent regions as detected by a script (everything is below a certain dB value for example).
- These were not listened to in any of the months. However, their calculation in final listened time depends on the months. 


***Make ups***

- If a skip or silence overlaps with a subregion of a rank where we would have liked to listen to (for instance, a subregion ranked 1 has a small overlap with a skip region), then we make up for that time that we didn't listen to by listening to a portion of a lesser ranked subregion. 
- Since months 6 and 7 do not have subregions, they also do not have make up regions. 

***Extra Time***

- If the strategy for make up time doesn't work (if the lower ranked subregions are not usable for some reason), then any time we listen to that does not fall within a subregion is called Extra Time. 
- Since months 6 and 7 do not have subregions, they also do not have extra time regions. 

Let's see what we've got in listened_time

```{r read, message=FALSE}

listened_time <- read_csv("../output/Total_Listen_Time_Summary.csv")
listened_time_with_months <- listened_time %>% 
  separate(filename, into = c("subj","month"), sep = "_", extra="drop",remove=F)
skim(listened_time_with_months)
```

  
Here we calculate the average, minimum and maximum listen time per month in hours, rounded to two decimal places. These should be a general indication of issues for that month's listened times.

```{r avg}
avgs <- listened_time_with_months %>% 
  group_by(month) %>% 
  summarise(mean_listen_time = round(mean(total_listen_time_hour), 2),
            sd_listen_time = round(sd(total_listen_time_hour),2),
            max = max(total_listen_time_hour), 
            min = min(total_listen_time_hour)
            )
knitr::kable(
  avgs,
  caption = "Mean, maximum and minimum listened time per month in hours"
) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = T, fixed_thead = T)

```


Below is a short section of the format of the csv file with only the **hour variables**. This should help with quick sanity checks. Note that for months 6 and 7, total listen time is calculated by subtracting skip and silence times from the last available time stamp in a file. **These files are not listed here because they are problematic! (As in there is nothing wrong with them, they are just displayed here as an example)** 
```{r mutated, echo=FALSE}
knitr::kable(
  listened_time_with_months[1:5,] %>% select(filename, ends_with("hour")),
  caption = "A tibble of listened time csv file"
) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = 'left')
```

## Listen Time Histograms 
Below are the histograms for each month.

<details><summary>Click for month by month histograms</summary>
<div>
```{r histograms, out.width="%25"}
ggplot(data = listened_time_with_months) + geom_histogram(mapping = aes(x = total_listen_time_hour),binwidth=.25) + facet_wrap(~ month, scales = "free") +
  labs(x = "Total listened time in hours", y = "Number of files")
```

</div>
</details>

## Problem File List
Please find below additional analysis and listings of possibly problematics files.

## Month 6 and 7
As a reminder: in month 6 and 7 'silence finder' process demarcated silences, and skips were marked to denote
time that someone in the future probably needn't listen to at all (e.g. long car rides with a radio playing)
[in months 8-17 skips carried a different meaning, see below].

There are `r count(listened_time_with_months %>% filter(month %in% c("06","07")))` 6 and 7 month files.

Calculation formula for these months is as follows:

$$total\_listen\_time\_hour = end\_time\_hour - (skip\_time\_hour + silence\_time\_hour - skip\_silence\_overlap\_hour)$$
According to this calculation, the files below are listed as **potentially problematic** since their total listen time is either >12 hours (unlikely for infants this age to be awake that much) or <8 hours (should double check for any errors in the file since that's <50% of full recording capacity).  Note the silence_raw_hour variable here will be the same as the silence_time_hour variable. 
That is, for months 6 and 7, silent and skip regions are **not modified**, hence we do not include their raw versions (instead we calculate their overlap, which is not done for the rest of the months). 

<details><summary>Click for months 6-7 problematic files</summary>
<div>
```{r sixseven, message=FALSE}
headers <- c(
  "filename", 
  "month", 
  "silence_time_hour", 
  "skip_time_hour", 
  "skip_silence_overlap_hour", 
  "end_time_hour", 
  "total_listen_time_hour"
  )
sixseven_summary <- 
  listened_time_with_months %>%
  select(headers) %>%
  filter(month %in% c("06","07") & (total_listen_time_hour>12 | total_listen_time_hour<8)) %>%
  mutate(calculation_of_listen_time_hour = sprintf("= %s - (%s + %s - %s)", end_time_hour, skip_time_hour, silence_time_hour, skip_silence_overlap_hour)) %>% 
  arrange(total_listen_time_hour)

write_csv(sixseven_summary, 'sixseven_problems')

knitr::kable(sixseven_summary) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T)
```
</div>
</details>

As we can see above, n = `r count(sixseven_summary %>% filter(total_listen_time_hour>12))` (calculated interactively) files have >12 hours, and n = `r count(sixseven_summary %>% filter(total_listen_time_hour<8))` (calculated interactively) have <8 hours.


Alternatively,  we can assume that all skip time was technically **listened** to in the sense that it was part of the file and human coders checked manually that silences were really silent. 
So, we can either assume:

- The overlap between skip and silence was listened to (it is considered skip, **column case1**)
- The overlap between skip and silence was not listened to (it is part of silence, **column case2**)

In each case, we have a different calculation as shown below. The resulting listen times are also in the table below, within their respective case columns:
$$total\_listen\_time\_hour = end\_time\_hour - (silence\_time\_hour - skip\_silence\_overlap\_hour)$$
$$total\_listen\_time\_hour = end\_time\_hour - silence\_time\_hour$$
Using these calculations, and assuming the previous thresholds, the files below are flagged as **potentially problematic**, based on either their case1 or case2 values. 


```{r alternative, message = FALSE}
alternative <- listened_time_with_months %>%
  filter(month %in% c("06", "07")) %>%
  select(headers) %>%
  mutate(case1 = end_time_hour - (silence_time_hour - skip_silence_overlap_hour), case2 = end_time_hour - silence_time_hour) %>%
  filter(case1 > 12 | case1 < 8 | case2 > 12 | case2 < 8) %>% 
  arrange(total_listen_time_hour)

knitr::kable(alternative) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T)
```

As seen in the table, above, `r count(alternative)` (interactively calculated) files are worth double checking for one of these cases.


## Month 8-17: Subregions and other types of regions.

For these months, the calculation of listened time is as follows:
$$total\_time = subregion\_time + extra\_time + makeup\_time + surplus\_time - silence\_time - skip\_time$$
Unlike months 6 and 7, total_time is obtained by adding up regions, rather than subtracting from the recording's end time. Before using this formula, the script preprocesses all the regions according to certain rules. Some assumptions/procedures/rules the script follows in this calculation:

* Any region of any type completely nested within a skip is removed. 

* silence_time is the sum of all silent regions that **overlap with** any subregion. So if a silent region is not embedded in a subregion, it is not included in silence_time. 

* subregions without any annotations are not included. 
* subregions that have any nested makeup or surplus are removed from the subregion_time sum, since only the surplus or makeup within that region needs to be included. 
* subregions that have any partial overlap with surplus are also removed from this sum.

Also note the raw variables, which are unmodified totals. So, for example, while `num_subregion_with_annot` variable only includes the number of subregions with annotations, `num_raw_subregion` includes the count of all subregions. 

Note:  `subregion_raw_hour` and `silence_raw_hour` are the totals of these types of regions without the removals according to the rules above.

We separately display files with < 5 subregions in the file. These should be double checked for audio recording length, as **potential concerns**

### month 8-13

Assumed target length: 4 hours; listing **problematic** files that are <3.75 or >4.25

First let's print out any files that don't have 5 subregions, and provide an overview
```{r eight_to_thirteen, message=FALSE}
eight2thirteen <- 
  listened_time_with_months %>% 
  filter(month %in% c("08","09","10","11","12","13") & (total_listen_time_hour>4.25 | total_listen_time_hour<3.75 | num_raw_subregion<5)) %>%
  select(filename, month, ends_with("hour"),  -skip_silence_overlap_hour, contains("raw")) %>% 
  arrange(total_listen_time_hour)

write_csv(eight2thirteen, 'eight2thirteen_problems')

listened_time_with_months %>% 
   filter(month %in% c("08","09","10","11","12","13") & num_raw_subregion<5) %>% 
  select(filename, month, ends_with("hour"),  -skip_silence_overlap_hour, contains("raw")) %>% 
  arrange(total_listen_time_hour) %>%
  knitr::kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T)

```

Out of `r count(listened_time_with_months %>% filter(month %in% c("08","09","10","11","12","13")))` (interactively calculated) recordings
at 8-13 months, (one recording, 22_09 was never collected):

`r count(eight2thirteen %>% filter(total_listen_time_hour>4.25))` (interactively calculated) are >4.25 &
`r count(eight2thirteen %>% filter(total_listen_time_hour<3.75))` (interactively calculated) are <3.75 hours of listened time.

Just one had < 5 subregions (`45_10` which was only 5.33 hours long). Moving on to the problematic files:

<details><summary>Click for months 8-13 problematic files</summary>
<div>
```{r bigtable}
knitr::kable(eight2thirteen, table.attr='class="bigTable"') %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
```
</div>
</details>

```{r}
eight2thirteen %>% 
  write_csv(file = "eight2thirteen_problem_files.csv")
```
### month 14-17
For these months, the calculation is exactly the same as months 8-13, but it the target length is 3 hours. 
Assumed target length: 3 hours, listing >3.25 and <2.75 as **problematic**

First let's print out any files that don't have 5 subregions, and provide an overview
```{r fourteen_to_seventeen}
fourteen2seventeen <-
  listened_time_with_months %>% 
  filter(month %in% c("14","15","16","17") & (total_listen_time_hour>3.25 | total_listen_time_hour<2.75)) %>%
  select(filename, month, ends_with("hour"),  -skip_silence_overlap_hour, contains("raw")) %>% 
  arrange(total_listen_time_hour)

write_csv(fourteen2seventeen, 'fourteen2seventeen_problems')
listened_time_with_months %>% 
   filter(month %in% c("14","15","16","17") & num_raw_subregion<5) %>% 
  select(filename, month, ends_with("hour"),  -skip_silence_overlap_hour, contains("raw")) %>% 
  arrange(total_listen_time_hour) %>%
  knitr::kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T)
```

Listing the potentially problematic files:
```{r fourteen2seventeen}
knitr::kable(fourteen2seventeen) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
```
Out of `r count(listened_time_with_months %>% filter(month %in% c("14","15","16","17")))` (interactively calculated) recordings
at 14-17 months:

`r count(fourteen2seventeen %>% filter(total_listen_time_hour>3.25))` (interactively calculated) are >3.25 &
`r count(fourteen2seventeen %>% filter(total_listen_time_hour<2.75))` (interactively calculated) are <2.75 hours of listened time.

Just one had < 5 subregions (`21_14` which was only 5.58 hours long)


## Positions and Ranks of subregions

Below, we calculate a table of subregion positions and ranks for each file.
I.e., we gather the subregion positions, ranks and number of annotations in each subregion for each file in all files  There is also information in the last column about the reasons for removing the subregion (NA means the subregion is not removed from the final listened time summary). 

```{r make sr rank and positions long, message=FALSE, warning= FALSE}
mini_listened_time_data <- listened_time_with_months %>% 
  dplyr::select(filename, subj, month, subregions, positions, ranks, counts, removals)

ranks_fixed <- mini_listened_time_data %>% 
  separate(ranks,  into= c("r1","r2","r3","r4","r5"), sep = "', '", remove = F) %>% 
  mutate( r1 = str_extract(r1, "\\d"),
          r2 = str_extract(r2, "\\d"),
          r3 = str_extract(r3, "\\d"),
          r4 = str_extract(r4, "\\d"),
          r5 = str_extract(r5, "\\d")) 

ranks_long <- ranks_fixed %>%  
  dplyr::select(filename, subj, month, r1:r5) %>% 
  pivot_longer(cols = r1:r5, names_to = "slot", values_to = "rank") %>% 
  mutate(slot = str_extract(slot, "\\d"))

positions_fixed <- mini_listened_time_data %>% 
  separate(positions,  into= c("p1","p2","p3","p4","p5"), sep = "', '", remove = F) %>%
  mutate( p1 = str_extract(p1, "\\d"),
          p2 = str_extract(p2, "\\d"),
          p3 = str_extract(p3, "\\d"),
          p4 = str_extract(p4, "\\d"),
          p5 = str_extract(p5, "\\d")) 

positions_long <- positions_fixed %>% 
  dplyr::select(filename, subj, month, p1:p5) %>% 
  pivot_longer(cols = p1:p5, names_to = "slot", values_to = "position") %>% 
  mutate(slot = str_extract(slot, "\\d"))

counts_fixed <- mini_listened_time_data %>%
  separate(counts, into= c("c1","c2","c3","c4","c5"), sep = ",", remove = F) %>%
  mutate( c1 = str_extract(c1, "\\d+"),
          c2 = str_extract(c2, "\\d+"),
          c3 = str_extract(c3, "\\d+"),
          c4 = str_extract(c4, "\\d+"),
          c5 = str_extract(c5, '\\d+')
    )

counts_long <- counts_fixed %>%
  select(filename, subj, month, c1:c5) %>%
  pivot_longer(cols = c1:c5, names_to = 'slot', values_to = 'counts') %>%
  mutate(slot = str_extract(slot, '\\d'))

removals_fixed <- mini_listened_time_data %>%
  separate(removals, into= c('re1', 're2', 're3', 're4', 're5'), sep = "', '", remove = FALSE) %>%
  mutate(
    re1 = str_extract(re1, "[A-Za-z\\s]+"),
    re2 = str_extract(re2, "[A-Za-z\\s]+"),
    re3 = str_extract(re3, "[A-Za-z\\s]+"),
    re4 = str_extract(re4, "[A-Za-z\\s]+"),
    re5 = str_extract(re5, "[A-Za-z\\s]+")
  )

removals_long <- removals_fixed %>%
  select(filename, subj, month, re1:re5) %>%
  pivot_longer(cols = re1:re5, names_to = 'slot', values_to = 'removals') %>%
  mutate(slot = str_extract(slot, '\\d'))
  

  
voila <- positions_long %>%
  left_join(ranks_long) %>%
  left_join(counts_long) %>%
  left_join(removals_long)

```

Let's first skim the result:

```{r Problem analysis45}
final <- 
  voila %>%
  filter(!(month %in% c('06', '07'))) %>%
  arrange(filename, position) %>%
  select(-slot)

skim(final)

# t1 <- final %>%
#   semi_join(eight2thirteen, by="filename")
# t2 <- final %>%
#   semi_join(fourteen2seventeen, by="filename")

# knitr::kable(t1, caption = 'Subregion summary for months 8 to 13') %>%
#       kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
# 
# knitr::kable(t2, caption = 'Subregion summary for months 14 to 17') %>%
#       kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
```

Uhoh, the skim shows 141 subregions with a position but no rank information. What's going on?

```{r missing ranks}
files_missing_rank <- final %>% 
  filter(is.na(rank)) %>% 
  group_by(filename, subj, month) %>% 
  summarise(num_sr_perfile = n_distinct(position)) %>% 
  arrange(num_sr_perfile, month)
files_missing_rank
```

See above, there appear to be `r nrow(files_missing_rank)` files with at least 1 missing subregion.
This is **problematic** and needs to be looked into.
(I think at some point subregion 5 was just called 'last', but this should be fixed)

Let's do some more sanity checks.
There should be 44 (kids) * 10 (months 8-17) *5 (subregions) - (7 (i missing file, 2 missing subregions)) subregions total, i.e. 44*10*5 - 7 = 2193. And there are :

`r count(final) - count(filter(final, is.na(position)))` Phew.


### Which files have subregions that have counts in them but shouldn't?
```{r subregions extra counts}
  
final %>% 
  filter(month %in% c("08","09","10","11","12","13") & rank=="5" & counts != "0" & is.na(removals))

final %>% 
  filter(month %in% c("14","15","16","17") & (rank=="5"| rank=="4")  & counts != "0" & is.na(removals))

```


### Which files have subregions that have don't have counts in them but should?
```{r subregion missing counts}
  
final %>% 
  filter(month %in% c("08","09","10","11","12","13") & rank!="5" & counts == "0")

final %>% 
  filter(month %in% c("14","15","16","17") & (rank!="5"&  rank!="4")  & counts == "0")

```


<details><summary>Click here to view the subregion summary for the entire 8-17 month set of files in the corpus.</summary>
``` {r final table}
knitr::kable(final, caption = 'Subregion summary for the entire corpus') %>%
       kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
```
</details>

## Outside annotation counts:

Below is a summary of annotation counts inside subregions by position. Months 6 and 7 are removed as usual since they do not contain any any subregions. Some things to take note of:
- The numbered variables indicate number of annotations inside that subregion, **without removing the subregion for any reason**. 
- The total, similarly, is the sum of all annotations in a file. 
- outside variable is the number of annotations that are not in a subregion, makeup region, or an extra region (surplus is not considered as of now). Note that if a makeup region is nested inside a given subregion, we remove that subregion, hence any annotations inside that subregion **not inside the makeup region** are considered outside.
- The **inside** variable added via mutate is the total number of annotations that are considered inside in contrast to annotations outside as defined above. It is defined as total number of annotations minus outside annotations. As a sanity check, there are no files with negative number of inside annotations.   

<details><summary>Annotation counts for the entire corpus</summary>
<div>
```{r subregion counts, message= F, warning= F}
counts_by_region <- 
  read_csv('../output/counts_by_region.csv') %>%
  separate(filename, into = c("subj","month"), sep = "_", extra="drop",remove=F) %>%
  filter(!(month %in% c("06", "07"))) %>%
  mutate(inside = total - outside)

counts_by_region %>%
knitr::kable(caption = 'Annotation counts by subregion for the entire corpus') %>%
       kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")

```
</div>

## Timeline Data

Below, we read in the timeline data:
<details><summary>Timeline summary for the entire corpus</summary>
<div>
```{r timeline, message = F}
timeline <- read_csv('../output/timeline_data.csv')

timeline %>%
knitr::kable(caption = 'Timeline summary for the entire corpus') %>%
       kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")

```
</div>