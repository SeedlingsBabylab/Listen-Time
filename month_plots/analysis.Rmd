---
title: "Listened time analysis by month"
author: "Sarp Uner"
date: "`r format(Sys.time())`"
output: html_document
---
<style>
  .bigTable {
    float:left
  }
</style>
```{r setup, include=FALSE, fig.width=8, fig.asp=0.618}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = normalizePath(".."))
#eb: i commented out the above so paths will work as they should; under
# knit you always want the knit directory to be the *project* directory
library(tidyverse)
library(kableExtra)


```

## Listened Time

The final listened time output generated by the python script.  Below, we read the Total_Listen_Time_Summary.csv file, and pull the month data from the filename for later use.

```{r read, message=FALSE}

listened_time <- read_csv("../output/Total_Listen_Time_Summary.csv")
listened_time_with_months <- listened_time %>% 
  separate(filename, into = c("subj","month"), sep = "_", extra="drop",remove=F)
```


Here we calculate the average, minimum and maximum listen time per month in hours, rounded to two decimal places. These should be a general indication of issues for that month's listened times.

```{r avg}
avgs <- listened_time_with_months %>% 
  group_by(month) %>% 
  summarise(avg_listen_time = round(mean(total_listen_time_hour), 2), 
            max = max(total_listen_time_hour), 
            min = min(total_listen_time_hour)
            )
knitr::kable(
  avgs,
  caption = "Mean, maximum and minimum listened time per month in hours"
) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = T, fixed_thead = T)

```


Below is a short section of the format of the csv file with only the **hour variables**. This should help with quick sanity checks. Note that for months 6 and 7, total listen time is calculated by subtracting skip and silence times from the last available time stamp in a file. 
```{r mutated, echo=FALSE}
knitr::kable(
  listened_time_with_months[1:5,] %>% select(filename, ends_with("hour")),
  caption = "A tibble of listened time csv file"
) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = 'left')
```

## Listen Time Histograms 
Below are the histograms for each month. 
```{r histograms, out.width="%25"}
ggplot(data = listened_time_with_months) + geom_histogram(mapping = aes(x = total_listen_time_hour),binwidth=.25) + facet_wrap(~ month, scales = "free") +
  labs(x = "Total listened time in hours", y = "Number of files")
```

## Problem File List
Please find below additional analysis and listings of problematics files.

### month 6 and 7
Calculation formula for these months is as follows:

$$total\_listen\_time\_hour = end\_time\_hour - (skip\_time\_hour + silence\_time\_hour - skip\_silence\_overlap\_hour)$$
According to this calculation, the files below are listed as **problematic** since their total listen time is either below or above a certain value. Note the silence_raw_hour variable. For months 6 and 7, silent and skip regions are **not modified**, hence we do not include their raw versions (instead we calculate their overlap, which is not done for the rest of the months). 
```{r sixseven, message=FALSE}
headers <- c(
  "filename", 
  "month", 
  "silence_time_hour", 
  "skip_time_hour", 
  "skip_silence_overlap_hour", 
  "end_time_hour", 
  "total_listen_time_hour"
  )
sixseven_summary <- 
  listened_time_with_months %>%
  select(headers) %>%
  filter(month %in% c("06","07") & (total_listen_time_hour>12 | total_listen_time_hour<8)) %>%
  mutate(calculation_of_listen_time_hour = sprintf("= %s - (%s + %s - %s)", end_time_hour, skip_time_hour, silence_time_hour, skip_silence_overlap_hour))

knitr::kable(sixseven_summary) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T)
```

Alternatively, based on my discussion with Shannon, we can assume that all skip time is technically **listened**. Note that for this case, we can either assume:

- The overlap between skip and silence is listened (it is considered skip, **column case1**)
- The overlap between skip and silence is not listened (it is part of silence, **column case2**)

In each case, we have a different calculation as shown below. The resulting listen times are also in the table below, within their respective case columns:
$$total\_listen\_time\_hour = end\_time\_hour - (silence\_time\_hour - skip\_silence\_overlap\_hour)$$
$$total\_listen\_time\_hour = end\_time\_hour - silence\_time\_hour$$
Using these calculations, and assuming the previous thresholds, the files below are flagged as **problematic**, based on either their case1 or case2 values.
```{r alternative, message = FALSE}
alternative <- listened_time_with_months %>%
  filter(month %in% c("06", "07")) %>%
  select(headers) %>%
  mutate(case1 = end_time_hour - (silence_time_hour - skip_silence_overlap_hour), case2 = end_time_hour - silence_time_hour) %>%
  filter(case1 > 12 | case1 < 8 | case2 > 12 | case2 < 8)

knitr::kable(alternative) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T)
```
### month 8-13
For these months, the calculation of listened time is as follows:
$$total\_time = subregion\_time + extra\_time + makeup\_time + surplus\_time - silence\_time - skip\_time$$
Unlike months 6 and 7, total_time is obtained by adding up regions, rather than subtracting from the recording's end time. Before using this formula, the script preprocesses all the regions according to certain rules. Some assumptions/procedures/rules the script follows in this calculation:

* Any region of any type completely nested within a skip is removed. 

* silence_time is the sum of all silent regions that **overlap with** any subregion. So if a silent region is not embedded in a subregion, it is not included in silence_time. 

* subregions without any annotations are not included. 
* subregions that have any nested makeup or surplus are removed from the subregion_time sum, since only the surplus or makeup within that region needs to be included. 
* subregions that have any partial overlap with surplus are also removed from this sum.

Also note the raw variables, which are unmodified totals. So, for example, while `num_subregion_with_annot` variable only includes the number of subregions with annotations, `num_raw_subregion` includes the count of all subregions. As expected, every file has 5 subregions (except 6 and 7 month files, which don't have subregions). Similarly, `subregion_raw_hour` and `silence_raw_hour` are the totals of these types of regions without the removals according to the rules above. As a sanity check, I added the condition to check if there are less than 5 subregions below. 

Assumed target length: 4 hours
```{r eight_to_thirteen}
eight2thirteen <- 
  listened_time_with_months %>% 
  filter(month %in% c("08","09","10","11","12","13") & (total_listen_time_hour>4.25 | total_listen_time_hour<3.75 | num_raw_subregion<5)) %>%
  select(filename, month, ends_with("hour"),  -skip_silence_overlap_hour, contains("raw"))
```


```{r bigtable}
knitr::kable(eight2thirteen, table.attr='class="bigTable"') %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
```

Aha, only file `45_10`, but that one has an `end_time` (the last time stamp in the cha file) of 5.33, so that doesn't look bad. 

### month 14-17
For these months, the calculation is exactly the same as months 8-13, but it the target length is 3 hours. 
Assumed target length: 3 hours
```{r fourteen_to_seventeen}
fourteen2seventeen <-
  listened_time_with_months %>% 
  filter(month %in% c("14","15","16","17") & (total_listen_time_hour>3.25 | total_listen_time_hour<2.75)) %>%
  select(filename, month, ends_with("hour"),  -skip_silence_overlap_hour, contains("raw"))

knitr::kable(fourteen2seventeen) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
```

### Positions and Ranks of subregions
Below, is a table of subregion positions and ranks for each file.
```{r make sr rank and positions long, message=FALSE, warning= FALSE}
#eb: note: you want ALL five positions and ranks in the spreadsheet but i'm 
# just showing you how i'd do it for the version of the data that's there now
#that's why p5 and r5 are all NA--they wont' be with the right data form
mini_listened_time_data <- listened_time_with_months %>% 
  dplyr::select(filename, subj, month, subregions, positions, ranks, counts, removals)

ranks_fixed <- mini_listened_time_data %>% 
  separate(ranks,  into= c("r1","r2","r3","r4","r5"), sep = "', '", remove = F) %>% 
  #mutate( r1 = str_remove_all(r1, c(literal("['") | literal("[]") | literal(",]""))))
  mutate( r1 = str_extract(r1, "\\d"),
          r2 = str_extract(r2, "\\d"),
          r3 = str_extract(r3, "\\d"),
          r4 = str_extract(r4, "\\d"),
          r5 = str_extract(r5, "\\d")) 

ranks_long <- ranks_fixed %>%  
  dplyr::select(filename, subj, month, r1:r5) %>% 
  pivot_longer(cols = r1:r5, names_to = "slot", values_to = "rank") %>% 
  mutate(slot = str_extract(slot, "\\d"))

positions_fixed <- mini_listened_time_data %>% 
  separate(positions,  into= c("p1","p2","p3","p4","p5"), sep = "', '", remove = F) %>%
  mutate( p1 = str_extract(p1, "\\d"),
          p2 = str_extract(p2, "\\d"),
          p3 = str_extract(p3, "\\d"),
          p4 = str_extract(p4, "\\d"),
          p5 = str_extract(p5, "\\d")) 

positions_long <- positions_fixed %>% 
  dplyr::select(filename, subj, month, p1:p5) %>% 
  pivot_longer(cols = p1:p5, names_to = "slot", values_to = "position") %>% 
  mutate(slot = str_extract(slot, "\\d"))

counts_fixed <- mini_listened_time_data %>%
  separate(counts, into= c("c1","c2","c3","c4","c5"), sep = ",", remove = F) %>%
  mutate( c1 = str_extract(c1, "\\d+"),
          c2 = str_extract(c2, "\\d+"),
          c3 = str_extract(c3, "\\d+"),
          c4 = str_extract(c4, "\\d+"),
          c5 = str_extract(c5, '\\d+')
    )

counts_long <- counts_fixed %>%
  select(filename, subj, month, c1:c5) %>%
  pivot_longer(cols = c1:c5, names_to = 'slot', values_to = 'counts') %>%
  mutate(slot = str_extract(slot, '\\d'))

removals_fixed <- mini_listened_time_data %>%
  separate(removals, into= c('re1', 're2', 're3', 're4', 're5'), sep = "', '", remove = FALSE) %>%
  mutate(
    re1 = str_extract(re1, "[A-Za-z\\s]+"),
    re2 = str_extract(re2, "[A-Za-z\\s]+"),
    re3 = str_extract(re3, "[A-Za-z\\s]+"),
    re4 = str_extract(re4, "[A-Za-z\\s]+"),
    re5 = str_extract(re5, "[A-Za-z\\s]+")
  )

removals_long <- removals_fixed %>%
  select(filename, subj, month, re1:re5) %>%
  pivot_longer(cols = re1:re5, names_to = 'slot', values_to = 'removals') %>%
  mutate(slot = str_extract(slot, '\\d'))
  

  
voila <- positions_long %>%
  left_join(ranks_long) %>%
  left_join(counts_long) %>%
  left_join(removals_long)
#eb: double check that this does the right thing by looking at wide & long versions manually


# mini_listened_time_data %>% dplyr::select(filename, ranks, positions)
#eb: as long as this does the right thing when you add the 5th SR, should be good!
```
Below, we gather the subregion positions, ranks and number of annotations in each subregion for each file in the problem files list above. Similar to the analysis above, we divide into 8-13 and 14-17 month groups. 
```{r Problem analysis}
final <- 
  voila %>%
  filter(!(month %in% c('06', '07'))) %>%
  arrange(filename, position) %>%
  select(-slot)

t1 <- final %>%
  semi_join(eight2thirteen, by="filename")
t2 <- final %>%
  semi_join(fourteen2seventeen, by="filename")

knitr::kable(t1, caption = 'Subregion summary for months 8 to 13') %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")

knitr::kable(t2, caption = 'Subregion summary for months 14 to 17') %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"), full_width = F, fixed_thead = T, position="left")
```